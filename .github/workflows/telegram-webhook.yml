name: ğŸ¤– Telegram Bot Webhook Handler

on:
  repository_dispatch:
    types: [telegram-callback]
  workflow_dispatch:
    inputs:
      callback_data:
        description: 'Callback data from Telegram'
        required: true
        default: 'generate_post'

jobs:
  handle-telegram-callback:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        cd gemini_test_standalone
        npm install
        
    - name: ğŸ¤– Handle Telegram Callback
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        CALLBACK_DATA: ${{ github.event.inputs.callback_data || github.event.client_payload.callback_data || 'generate_post' }}
      run: |
        cd gemini_test_standalone
        echo "ğŸ¤– Handling Telegram callback: $CALLBACK_DATA"
        
        # Generate post based on callback
        if [ "$CALLBACK_DATA" = "generate_post" ] || [ "$CALLBACK_DATA" = "trigger_github" ]; then
          echo "ğŸš€ Generating LinkedIn post..."
          node telegram_bot.js --auto
        elif [ "$CALLBACK_DATA" = "show_stats" ]; then
          echo "ğŸ“Š Showing statistics..."
          node -e "
            const { showDatabaseStats } = require('./generate_authentic_varied_posts.js');
            const fetch = require('node-fetch');
            
            async function sendStats() {
              try {
                const stats = await showDatabaseStats();
                const statsText = \`ğŸ“Š Statistiques de la Base de DonnÃ©es:\\n\\n\` +
                  \`ğŸ“ Total posts: \${stats.total_posts}\\n\` +
                  \`âœ… Posts avec IA: \${stats.real_posts}\\n\` +
                  \`âš ï¸ Posts fallback: \${stats.fallback_posts}\\n\` +
                  \`ğŸ¨ Types uniques: \${stats.unique_types}\\n\`;
                
                const response = await fetch(\`https://api.telegram.org/bot\${process.env.TELEGRAM_BOT_TOKEN}/sendMessage\`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    chat_id: process.env.TELEGRAM_CHAT_ID,
                    text: statsText,
                    parse_mode: 'HTML'
                  })
                });
                console.log('âœ… Stats sent to Telegram');
              } catch (error) {
                console.error('âŒ Error sending stats:', error);
              }
            }
            sendStats();
          "
        elif [ "$CALLBACK_DATA" = "show_help" ]; then
          echo "â„¹ï¸ Showing help..."
          node -e "
            const fetch = require('node-fetch');
            
            async function sendHelp() {
              try {
                const helpText = \`ğŸ¤– Bot LinkedIn Post Generator\\n\\n\` +
                  \`ğŸ¯ FonctionnalitÃ©s:\\n\` +
                  \`â€¢ GÃ©nÃ©ration de posts LinkedIn avec IA Gemini 2.5 Flash\\n\` +
                  \`â€¢ Images automatiques avec Unsplash\\n\` +
                  \`â€¢ Contenu authentique et variÃ©\\n\` +
                  \`â€¢ Ã‰vitement des rÃ©pÃ©titions\\n\\n\` +
                  \`ğŸ”§ Configuration requise:\\n\` +
                  \`â€¢ GEMINI_API_KEY (obligatoire)\\n\` +
                  \`â€¢ TELEGRAM_BOT_TOKEN\\n\` +
                  \`â€¢ TELEGRAM_CHAT_ID\\n\\n\` +
                  \`ğŸ“± Utilisation:\\n\` +
                  \`â€¢ ğŸ¤– GÃ©nÃ©rer un Post: CrÃ©e un post immÃ©diatement\\n\` +
                  \`â€¢ ğŸš€ DÃ©clencher GitHub Actions: Utilise le code dÃ©ployÃ©\\n\` +
                  \`â€¢ ğŸ”„ Changer la Photo: Nouvelle image pour le mÃªme contenu\\n\` +
                  \`â€¢ Le post est prÃªt Ã  copier-coller sur LinkedIn\\n\` +
                  \`â€¢ Images automatiquement associÃ©es\\n\\n\` +
                  \`ğŸš€ Automatisation:\\n\` +
                  \`â€¢ Posts automatiques Ã  9h et 14h (GitHub Actions)\\n\` +
                  \`â€¢ SystÃ¨me anti-rÃ©pÃ©tition intÃ©grÃ©\\n\\n\` +
                  \`ğŸ’¡ Conseil: Utilisez GÃ©nÃ©rer pour tester, GitHub Actions pour la production !\`;
                
                const response = await fetch(\`https://api.telegram.org/bot\${process.env.TELEGRAM_BOT_TOKEN}/sendMessage\`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    chat_id: process.env.TELEGRAM_CHAT_ID,
                    text: helpText,
                    parse_mode: 'HTML'
                  })
                });
                console.log('âœ… Help sent to Telegram');
              } catch (error) {
                console.error('âŒ Error sending help:', error);
              }
            }
            sendHelp();
          "
        else
          echo "âŒ Unknown callback data: $CALLBACK_DATA"
        fi
        
    - name: ğŸ“Š Post execution summary
      if: always()
      run: |
        echo "ğŸ¤– Telegram Bot Webhook - Execution Summary"
        echo "â° Time: $(date)"
        echo "ğŸ“… Date: $(date +%Y-%m-%d)"
        echo "ğŸ• Hour: $(date +%H:%M)"
        echo "âœ… Job completed"
